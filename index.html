<!DOCTYPE html>
<html>

<head>
    <title>Microservices Checkout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            padding-top: 50px;
            background: #f0f2f5;
        }

        .box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 300px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #2ecc71;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        #msg {
            font-size: 0.8rem;
            color: #555;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="box">
        <h3>E-Shop Payment</h3>
        <input type="email" id="email" placeholder="Email" value="test@example.com">
        <input type="number" id="amount" placeholder="Amount" value="500">
        <button id="payBtn">CREATE & PAY</button>
        <div id="msg"></div>
    </div>

    <script>
        // 1. Define base URLs for both microservices
        // NOTE: If using Docker, ensure Port 5030 is mapped to 8080 in docker-compose.yml
        const ORDER_SERVICE_URL = "http://localhost:5170";
        const PAYMENT_SERVICE_URL = "http://localhost:5030";

        const API_ORDERS = `${ORDER_SERVICE_URL}/api/Orders`;
        const API_PAYMENTS = `${PAYMENT_SERVICE_URL}/api/Payments`;

        const RZP_KEY = "rzp_test_RwfRliWpgJyiG6";

        document.getElementById('payBtn').onclick = async function () {
            const btn = this;
            const msg = document.getElementById('msg');
            const email = document.getElementById('email').value;
            const amount = document.getElementById('amount').value;

            if (!email || !amount) { alert("Please enter email and amount"); return; }

            btn.disabled = true;
            msg.style.color = "blue";

            try {
                // STEP 1: Create Order in Order Service (Port 5170)
                msg.innerText = "Creating order...";
                const res = await fetch(`${API_ORDERS}/CreateOrder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(amount), customerEmail: email })
                });

                if (!res.ok) throw new Error("Failed to create order in Order Service");
                const { orderId } = await res.json();

                // STEP 2: Initialize SignalR Hub (Order Service keeps track of the connection)
                msg.innerText = "Connecting to notification hub...";
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl(`${ORDER_SERVICE_URL}/orderHub`)
                    .withAutomaticReconnect()
                    .build();

                await connection.start();
                await connection.invoke("JoinOrderGroup", orderId.toString());

                // STEP 3: Listen for Razorpay Order ID (Created by Payment Service via RabbitMQ)
                connection.on("UpdateRazorpayId", (razorpayId) => {
                    console.log("Received Razorpay Order ID:", razorpayId);
                    msg.innerText = "Opening Secure Gateway...";

                    const options = {
                        "key": RZP_KEY,
                        "amount": amount * 100,
                        "order_id": razorpayId,
                        "handler": async function (resp) {
                            msg.innerText = "Verifying payment signature...";
                            msg.style.color = "orange";

                            // STEP 4: DECOUPLED VERIFICATION - Call Payment Service (Port 5030)
                            try {
                                const confirm = await fetch(`${API_PAYMENTS}/ConfirmPayment`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        orderId: orderId, // The internal DB GUID
                                        razorpayOrderId: resp.razorpay_order_id,
                                        razorpayPaymentId: resp.razorpay_payment_id,
                                        razorpaySignature: resp.razorpay_signature
                                    })
                                });

                                if (confirm.ok) {
                                    const result = await confirm.json();
                                    msg.innerText = "✅ " + result.message;
                                    msg.style.color = "green";
                                    // Redirect after a short delay so user sees success message
                                    setTimeout(() => {
                                        window.location.href = `success.html?orderId=${orderId}`;
                                    }, 2000);
                                } else {
                                    const errorData = await confirm.json();
                                    msg.innerText = "❌ Verification Failed: " + (errorData.message || "Invalid Signature");
                                    msg.style.color = "red";
                                    btn.disabled = false;
                                }
                            } catch (fetchErr) {
                                console.error("Network Error:", fetchErr);
                                msg.innerText = "❌ Network Error: Could not reach Payment Service at Port 5030. Check if service is running.";
                                msg.style.color = "red";
                                btn.disabled = false;
                            }
                        },
                        "modal": {
                            "ondismiss": async function () {
                                msg.innerText = "Payment cancelled by user.";
                                msg.style.color = "black";

                                // STEP 5: Notify Order Service of manual cancellation
                                try {
                                    await fetch(`${API_ORDERS}/CancelOrder/${orderId}`, { method: 'POST' });
                                } catch (err) {
                                    console.error("Cancelation sync failed:", err);
                                }

                                btn.disabled = false;
                                btn.innerText = "CREATE & PAY";
                            }
                        },
                        "theme": { "color": "#3399cc" }
                    };

                    new Razorpay(options).open();
                    connection.stop();
                });

            } catch (e) {
                console.error("Process Error:", e);
                alert("Error: " + e.message);
                btn.disabled = false;
                msg.innerText = "Error occurred. Please try again.";
                msg.style.color = "red";
            }
        };
    </script>
</body>

</html>
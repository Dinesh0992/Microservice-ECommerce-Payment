<!DOCTYPE html>
<html>

<head>
    <title>Microservices Checkout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            padding-top: 50px;
            background: #f0f2f5;
        }

        .box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 300px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #2ecc71;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        #msg {
            font-size: 0.8rem;
            color: #555;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="box">
        <h3>E-Shop Payment</h3>
        <input type="email" id="email" placeholder="Email" value="test@example.com">
        <input type="number" id="amount" placeholder="Amount" value="500">
        <button id="payBtn">CREATE & PAY</button>
        <div id="msg"></div>
    </div>

    <script>
        // Use the port where your Order.Service is running (5170 based on your code)
        const BASE_URL = "http://localhost:5170";
        const API_URL = `${BASE_URL}/api/Orders`;
        const RZP_KEY = "rzp_test_RwfRliWpgJyiG6";

        document.getElementById('payBtn').onclick = async function () {
            const btn = this;
            const msg = document.getElementById('msg');
            const email = document.getElementById('email').value;
            const amount = document.getElementById('amount').value;

            btn.disabled = true; // Prevent double clicks

            try {
                // STEP 1: Create Order in Order Service
                msg.innerText = "Creating order...";
                const res = await fetch(`${API_URL}/CreateOrder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(amount), customerEmail: email })
                });

                // Based on your current API, this returns { orderId: ... }
                const { orderId } = await res.json();

                // STEP 2: Initialize SignalR instead of Polling
                msg.innerText = "Waiting for Payment Gateway...";

                const connection = new signalR.HubConnectionBuilder()
                    .withUrl(`${BASE_URL}/orderHub`)
                    .withAutomaticReconnect()
                    .build();

                await connection.start();

                // Join the group for this specific order
                await connection.invoke("JoinOrderGroup", orderId.toString());

                // STEP 3: Listen for the Push from PaymentInitiatedConsumer
                connection.on("UpdateRazorpayId", (razorpayId) => {
                    console.log("Received Razorpay Order ID:", razorpayId);
                    msg.innerText = "Opening Gateway...";

                    const options = {
                        "key": RZP_KEY,
                        "amount": amount * 100,
                        "order_id": razorpayId,
                        "handler": async function (resp) {
                            msg.innerText = "Verifying payment...";

                            // STEP 4: Confirm Payment
                            const confirm = await fetch(`${API_URL}/ConfirmPayment`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    razorpayOrderId: resp.razorpay_order_id,
                                    razorpayPaymentId: resp.razorpay_payment_id,
                                    razorpaySignature: resp.razorpay_signature
                                })
                            });

                            const result = await confirm.json();

                            if (confirm.ok) {
                                // Task 2: Instead of reload, redirect to a success page
                                // We pass the orderId in the URL so the success page can show it
                                window.location.href = `success.html?orderId=${orderId}`;
                            } else {
                                alert("Verification Failed: " + result.message);
                                location.reload();
                            }
                        },
                        // Task 1: Handle User Closing the Modal (The "X" button)
                        "modal": {
                            "ondismiss": async function () {
                                console.log("Checkout form closed by user.");
                                msg.innerText = "Payment cancelled by user.";

                                // Notify backend to update status to 'Cancelled'
                                try {
                                    await fetch(`${API_URL}/CancelOrder/${orderId}`, {
                                        method: 'POST'
                                    });
                                    console.log("Order status updated to Cancelled in DB.");
                                } catch (err) {
                                    console.error("Failed to notify backend of cancellation:", err);
                                }

                                // Re-enable the button so the user can try again without refreshing
                                btn.disabled = false;
                                btn.innerText = "CREATE & PAY";
                            }
                        },
                        "theme": {
                            "color": "#3399cc"
                        }
                    };

                    new Razorpay(options).open();
                    connection.stop(); // Stop the hub after we get what we need
                });

            } catch (e) {
                alert("Error: " + e.message);
                btn.disabled = false;
                msg.innerText = "";
            }
        };
    </script>
</body>

</html>